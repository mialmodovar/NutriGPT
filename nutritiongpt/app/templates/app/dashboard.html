<!doctype html>
<html lang="en" dir="ltr">

<head>
    {% load static %}
    <!-- META DATA -->
    <meta charset="UTF-8">
    <meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=0'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Sash â€“ Bootstrap 5  Admin & Dashboard Template">
    <meta name="author" content="Spruko Technologies Private Limited">
    <meta name="keywords" content="admin,admin dashboard,admin panel,admin template,bootstrap,clean,dashboard,flat,jquery,modern,responsive,premium admin templates,responsive admin,ui,ui kit.">

    <!-- FAVICON -->
    <link rel="shortcut icon" type="image/x-icon" href=" {% static '/assets/images/brand/favicon.ico' %} ">

    <!-- TITLE -->
    <title>NutriGPT</title>

    <!-- BOOTSTRAP CSS -->
    <link id="style" href=" {% static '/assets/plugins/bootstrap/css/bootstrap.min.css' %} " rel="stylesheet">

    <!-- STYLE CSS -->
     <link href=" {% static '/assets/css/style.css' %} " rel="stylesheet">

	<!-- Plugins CSS -->
    <link href=" {% static '/assets/css/plugins.css' %} " rel="stylesheet">

    <!--- FONT-ICONS CSS -->
    <link href=" {% static '/assets/css/icons.css' %} " rel="stylesheet">

    <!-- INTERNAL Switcher css -->
    <link href=" {% static '/assets/switcher/css/switcher.css' %} " rel="stylesheet">
    <link href=" {% static '/assets/switcher/demo.css' %} " rel="stylesheet">
</head>

<body class="app sidebar-mini ltr light-mode">

    <!-- GLOBAL-LOADER -->
    <div id="global-loader">
        <img src=" {% static '/assets/images/loader.svg' %} " class="loader-img" alt="Loader">
    </div>
    <!-- /GLOBAL-LOADER -->

    <!-- PAGE -->
    <div class="page">
        <div class="page-main">

            <!-- app-Header -->
            <div class="app-header header sticky">
                <div class="container-fluid main-container">
                    <div class="d-flex">
                        <a aria-label="Hide Sidebar" class="app-sidebar__toggle" data-bs-toggle="sidebar" href=" {% static 'javascript:void(0)' %} "></a>
                        <!-- sidebar-toggle-->
                        <a class="logo-horizontal " href=" {% static 'index.html' %} ">
                            <img src=" {% static '/assets/images/brand/logo-white.png' %} " class="header-brand-img desktop-logo" alt="logo">
                            <img src=" {% static '/assets/images/brand/logo-dark.png' %} " class="header-brand-img light-logo1"
                                alt="logo">
                        </a>

                       
                        <div class="d-flex order-lg-2 ms-auto header-right-icons">
                            <!-- SEARCH -->
                            <button class="navbar-toggler navresponsive-toggler d-lg-none ms-auto" type="button"
                                data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent-4"
                                aria-controls="navbarSupportedContent-4" aria-expanded="false"
                                aria-label="Toggle navigation">
                                <span class="navbar-toggler-icon fe fe-more-vertical"></span>
                            </button>
                            <div class="navbar navbar-collapse responsive-navbar p-0">
                                <div class="collapse navbar-collapse" id="navbarSupportedContent-4">
                                    <div class="d-flex order-lg-2">
                                            <a href="{% static 'javascript:void(0)' %}" class="nav-link icon"
                                                data-bs-toggle="dropdown" data-target="">
                                                <i class="fa fa-sort-down"></i>
                                            </a>
                                        <!-- SIDE-MENU -->
                                        <div class="dropdown d-flex profile-1">
                                            <a href=" {% static 'javascript:void(0)' %} " data-bs-toggle="dropdown" class="nav-link leading-none d-flex">
                                                <img src=" {% static '/assets/images/users/21.jpg' %} " alt="profile-user"
                                                    class="avatar  profile-user brround cover-image">
                                            </a>
                                            <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                                                <div class="drop-heading">
                                                    <div class="text-center">
                                                        <h5 class="text-dark mb-0 fs-14 fw-semibold">{{request.user.username}}</h5>
                                                    </div>
                                                </div>
                                                <div class="dropdown-divider m-0"></div>
                                                <a class="dropdown-item" href=" {% url 'edit_profile' %} ">
                                                    <i class="dropdown-icon fe fe-user"></i> Profile
                                                </a>
                                                <a class="dropdown-item" href=" {% url 'logout' %} ">
                                                    <i class="dropdown-icon fe fe-alert-circle"></i> Sign out
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /app-Header -->

            <!--APP-SIDEBAR-->
            <div class="sticky">
                <div class="app-sidebar__overlay" data-bs-toggle="sidebar"></div>
                <div class="app-sidebar">
                    <div class="side-header">
                        <a class="header-brand1" href=" {% url 'dashboard' %} ">
                            <img src=" {% static '/assets/images/brand/logo-white.png' %} " class="header-brand-img desktop-logo" alt="logo">
                            <img src=" {% static '/assets/images/brand/icon-white.png' %} " class="header-brand-img toggle-logo"
                                alt="logo">
                            <img src=" {% static '/assets/images/brand/icon-dark.png' %} " class="header-brand-img light-logo" alt="logo">
                            <img src=" {% static '/assets/images/brand/logo-dark.png' %} " class="header-brand-img light-logo1"
                                alt="logo">
                        </a>
                        <!-- LOGO -->
                    </div>
                    <div class="main-sidemenu">
                        <div class="slide-left disabled" id="slide-left"><svg xmlns="http://www.w3.org/2000/svg"
                                fill="#7b8191" width="24" height="24" viewBox="0 0 24 24">
                                <path d="M13.293 6.293 7.586 12l5.707 5.707 1.414-1.414L10.414 12l4.293-4.293z" />
                            </svg></div>
                        <ul class="side-menu">
                           
                            <li class="slide">
                                <a class="side-menu__item has-link" data-bs-toggle="slide" href=" {% url 'dashboard' %} "><i
                                        class="side-menu__icon fe fe-home"></i><span
                                        class="side-menu__label">Dashboard</span></a>
                            </li>
                            <li class="slide">
                                <a class="side-menu__item has-link" data-bs-toggle="slide" href=" {% url 'chat' %} "><i
                                        class="side-menu__icon fe fe-send"></i><span
                                        class="side-menu__label">Chat</span></a>
                            </li>
                            <li class="slide">
                                <a class="side-menu__item has-link" data-bs-toggle="slide" href=" {% url 'food_diary' %} "><i
                                        class="side-menu__icon fe fe-pie-chart"></i><span
                                        class="side-menu__label">Food Diary</span></a>
                            </li>
                            <li class="slide">
                                <a class="side-menu__item has-link" data-bs-toggle="slide" href=" {% url 'exercise_diary' %} "><i
                                        class="side-menu__icon fe fe-activity"></i><span
                                        class="side-menu__label">Exercise Diary</span></a>
                            </li>

                        </ul>
                        <div class="slide-right" id="slide-right"><svg xmlns="http://www.w3.org/2000/svg" fill="#7b8191"
                                width="24" height="24" viewBox="0 0 24 24">
                                <path d="M10.707 17.707 16.414 12l-5.707-5.707-1.414 1.414L13.586 12l-4.293 4.293z" />
                            </svg></div>
                    </div>
                </div>
            </div>
            <!--/APP-SIDEBAR-->

            <!--app-content open-->
<div class="main-content app-content mt-0">
    <div class="side-app">

        <!-- CONTAINER -->
        <div class="main-container container-fluid">

            <!-- PAGE-HEADER -->
            <div class="page-header">
                <h1 class="page-title">Dashboard</h1>
                
            </div>
            <!-- PAGE-HEADER END -->

            <!-- ROW-1 OPEN -->
            <div class="row">
                <div class="col-lg-9 d-flex">
                    <!-- INSERT FOOD AND EXERCISE TABLES TAB -->
                    <div class="card flex-grow-1">
                        <div class="main-content-app pt-0">
                            <div class="main-content-body main-content-body-chat h-100">
                                <div class="main-chat-header pt-3 d-block d-sm-flex">
                                    <div class="main-img-user online"><img alt="avatar" src=" {% static '/assets/images/users/1.jpg' %} "></div>
                                    <div class="main-chat-msg-name mt-2">
                                        <h6>AI Bot</h6>
                                    </div>
                                    <nav class="nav">
                                        <div class="">
                
                                        </div>
                                        <div class="dropdown">
                                            <a class="nav-link" href=" {% static 'javascript:void(0)' %} " data-bs-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><i class="fe fe-more-horizontal"></i></a>
                                            <div class="dropdown-menu dropdown-menu-end">
                                                <a class="dropdown-item" href=" {% static 'javascript:void(0)' %} "><i class="fe fe-phone-call me-1"></i> Example in case you need it.</a>
                                            </div>
                                        </div>
                                    </nav>
                                </div>
                                <!-- main-chat-header -->
                                <div class="main-chat-body flex-2" id="ChatBody">
                                    <div class="content-inner">
                                    </div>
                                </div>
                                <div class="main-chat-footer">
                                    <input type="text" class="form-control border-0" id="user-message" placeholder="Type your message..." maxlength="200">
                                    <button type="button" id="send-message" class="btn btn-primary fe fe-send"></button>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 d-flex flex-column">
                    <div class="card" id="calorie-tracker">
                        <div class="card-body">
                            <h2 class="card-title">Calorie Tracker</h5>
                            <div class="progress progress-md">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-pink-1" style="width:"></div>
                        </div>
                        <br>
                            <h5 class="counter"></h5>
                    </div>
                    </div>
                    <div class="card" id="protein-tracker">
                        <div class="card-body">
                            <h2 class="card-title">Protein Tracker</h5>
                            <div class="progress progress-md">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-blue-1" style="width:"></div>
                        </div>
                        <br>
                            <h5 class="counter"></h5>
                    </div>
                    </div>
                    <div class="card" id="carbs-tracker">
                        <div class="card-body">
                            <h2 class="card-title">Carbs Tracker</h5>
                            <div class="progress progress-md">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-yellow-1" style="width:"></div>
                        </div>
                        <br>
                            <h5 class="counter"></h5>
                    </div>
                    </div>
                
                    <div class="card" id="fats-tracker">
                        <div class="card-body">
                            <h2 class="card-title">Fats Tracker</h5>
                            <div class="progress progress-md">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-green-1" style="width:"></div>
                        </div>
                        <br>
                            <h5 class="counter"></h5>
                    </div>
                    </div>
                    <div class="card flex-grow-1">
                        <div class="card-body">
                            <h2 class="card-title">Diary Tabs</h2>
                            <div class="panel panel-primary">
                                <div class="tab-menu-heading tab-menu-heading-boxed">
                                    <div class="tabs-menu tabs-menu-border">
                                        <!-- Tabs -->
                                        <ul class="nav panel-tabs" role="tablist">
                                            <li><a href="#exerciseDiary" class="active" data-bs-toggle="tab" aria-selected="true" role="tab">Exercise Diary</a></li>
                                            <li><a href="#mealDiary" data-bs-toggle="tab" aria-selected="false" tabindex="-1" role="tab">Meal Diary</a></li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="panel-body tabs-menu-body">
                                    <div class="tab-content">
                                        <div class="tab-pane active" id="exerciseDiary" role="tabpanel">
                                            <div class="table-responsive">
                                                <table id="example4" class="table table-bordered text-nowrap border-bottom">
                                                    <thead>
                                                        <tr>
                                                            <th class="border-bottom-0">Date</th>
                                                            <th class="border-bottom-0">Exercise Name</th>
                                                            <th class="border-bottom-0">Calories Burned</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <div class="tab-pane" id="mealDiary" role="tabpanel">
                                            <div class="table-responsive">
                                                <table id="example3" class="table table-bordered text-nowrap border-bottom">
                                                    <thead>
                                                        <tr>
                                                            <th class="border-bottom-0">Date</th>
                                                            <th class="border-bottom-0">Food Name</th>
                                                            <th class="border-bottom-0">Calories Gained</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
            </div>
            <!-- ROW-1 CLOSE -->

           

        </div>
        <!-- CONTAINER CLOSED -->
    </div>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <style>
            .typing-indicator {
                display: inline-block;
                width: 24px;
                height: 24px;
                background: url({% static '/assets/images/typing-indicator.gif' %}) center center no-repeat;
            }
            .main-chat-body { 

    overflow-y: auto;
}
        </style>

{% csrf_token %}
<script>
    function updateDashboardData() {
    $.ajax({
        url: "{% url 'get_dashboard_data' %}",
        method: "GET",
        data: {
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(data) {
            $('#calorie-tracker .progress-bar').css('width', data.calories_percentage + '%').text(data.calories_percentage + '%');
            $('#calorie-tracker .counter').text(data.daily_intake.calories.toFixed(0) + ' kcal of ' + data.userprofile.calories_goal.toFixed(0) + ' kcal');

            $('#protein-tracker .progress-bar').css('width', data.protein_percentage + '%').text(data.protein_percentage + '%');
            $('#protein-tracker .counter').text(data.daily_intake.protein.toFixed(0) + ' g of ' + data.userprofile.protein_goal.toFixed(0) + ' g');

            $('#carbs-tracker .progress-bar').css('width', data.carbs_percentage + '%').text(data.carbs_percentage + '%');
            $('#carbs-tracker .counter').text(data.daily_intake.carbohydrates.toFixed(0) + ' g of ' + data.userprofile.carbohydrates_goal.toFixed(0) + ' g');

            $('#fats-tracker .progress-bar').css('width', data.fats_percentage + '%').text(data.fats_percentage + '%');
            $('#fats-tracker .counter').text(data.daily_intake.fats.toFixed(0) + ' g of ' + data.userprofile.fats_goal.toFixed(0) + ' g');

            var exercises = JSON.parse(data.exercises);
            var foods = JSON.parse(data.foods);



            // Update exercise table
            var exerciseTableBody = $('#example4 tbody');
            exerciseTableBody.empty();
            exercises.forEach(function(exercise) {
                var row = $('<tr>');
                row.append($('<td>').text(exercise.fields.date));
                row.append($('<td>').text(exercise.fields.exercise_name));
                row.append($('<td>').text(exercise.fields.calories_burned));
                exerciseTableBody.append(row);
            });

            // Update food table
            var foodTableBody = $('#example3 tbody');
            foodTableBody.empty();
            foods.forEach(function(food) {
                var row = $('<tr>');
                row.append($('<td>').text(food.fields.date));
                row.append($('<td>').text(food.fields.food_name));
                row.append($('<td>').text(food.fields.calories_gained));
                foodTableBody.append(row);
            });
        }
    });
        }
    

    function getCurrentTimeString() {
        var now = new Date();
        var hours = now.getHours();
        var minutes = now.getMinutes();

        if (minutes < 10) {
            minutes = '0' + minutes;
        }

        return hours + ':' + minutes;
    }

    function createUserMessageElement(message, timestamp) {
        return `
            <div class="media flex-row-reverse chat-right">
                <div class="main-img-user online"><img alt="avatar" src="{% static '/assets/images/users/21.jpg' %}"></div>
                <div class="media-body">
                    <div class="main-msg-wrapper">${message}</div>
                    <div>
                        <span>${timestamp}</span> <a href="{% static 'javascript:void(0)' %}"><i class="icon ion-android-more-horizontal"></i></a>
                    </div>
                </div>
            </div>`;
    }

    function createBotResponseElement(response, timestamp) {
        return `
            <div class="media chat-left">
                <div class="main-img-user online"><img alt="avatar" src="{% static '/assets/images/users/1.jpg' %}"></div>
                <div class="media-body">
                    <div class="main-msg-wrapper">${response}</div>
                    <div>
                        <span>${timestamp}</span> <a href="{% static 'javascript:void(0)' %}"><i class="icon ion-android-more-horizontal"></i></a>
                    </div>
                </div>
            </div>`;
    }

    function displayInitialBotMessage() {
    const botInitialMessage = `
        <div class="media chat-left">
            <div class="main-img-user online"><img alt="avatar" src="{% static '/assets/images/users/1.jpg' %}"></div>
            <div class="media-body">
                <div class="main-msg-wrapper" id="bot-response">
                    Hi, I am your Fitness Companion bot. I am here to help you track your fitness goals and guide you on your health journey. 
                    <br> 
                    Here is your current information:
                    <br>
                    Date of Birth: {{ request.user.userprofile.date_of_birth }}
                    <br>
                    Weight: {{ request.user.userprofile.weight }} kg
                    <br>
                    Height: {{ request.user.userprofile.height }} cm
                    <br>
                    Gender: {{ request.user.userprofile.gender }}
                    <br>
                    If these details are not correct, you can change them <a href="{% url 'edit_profile' %}">here</a>.
                    <br>
                    Here are some examples of commands you can perform:
                    <br>
                    1. Set calories/macro goals: "I want to gain 0.3kg a week. Set my macros and calories accordingly."
                    <br>
                    3. Track food intake: "I ate a chicken sandwich."
                    <br>
                    4. Track exercise: "I ran for 30 minutes."
                    <br>
                    5. Undo food or exercise: "Undo the chicken sandwich."
                    <br>
                    6. Ask for meal suggestions: "What should I eat to meet my calorie goal?"
                    <br>
                    Let's get started on achieving your fitness goals! (Don't trust anything I say, I'm just a bot.)
                </div>
                <div>
                    <span>${getCurrentTimeString()}</span> <a href="{% static 'javascript:void(0)' %}"><i class="icon ion-android-more-horizontal"></i></a>
                </div>
            </div>
        </div>`;
    $('#ChatBody .content-inner').append(botInitialMessage);
}

    function createTypingIndicatorElement() {
        return `
            <div class="media chat-left typing-indicator-wrapper">
                <div class="main-img-user online"><img alt="avatar" src="{% static '/assets/images/users/1.jpg' %}"></div>
                <div class="media-body">
                    <div class="main-msg-wrapper">
                        <div class="typing-indicator"></div>
                    </div>
                </div>
            </div>`;
    }

    $(document).ready(function() {
        updateDashboardData();
        displayInitialBotMessage();

        $("#send-message").click(function() {
            var message = $("#user-message").val();
            $("#user-message").val(""); // Clear the input field
            var timestamp = getCurrentTimeString();

            // Append the user message to the chat body
            var userMessageElement = createUserMessageElement(message, timestamp);
            $("#ChatBody .content-inner").append(userMessageElement);

            // Show the typing indicator
            var typingIndicatorElement = createTypingIndicatorElement();
            $("#ChatBody .content-inner").append(typingIndicatorElement);

            // Disable the send button and input field while waiting for a response
            $("#send-message").prop("disabled", true);
            $("#user-message").prop("disabled", true);

            $.ajax({
                url: '{% url "chatbot_response" %}',
                method: 'POST',
                data: {
                    'message': message,
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                },
                success: function(response) {
                    // Remove the typing indicator
                    $(".typing-indicator-wrapper").remove();

                    // Append the bot response to the chat body
                    var botResponseElement = createBotResponseElement(response.response, timestamp);
                    $("#ChatBody .content-inner").append(botResponseElement);

                    // Re-enable the send button and input field
                    $("#send-message").prop("disabled", false);
                    $("#user-message").prop("disabled", false);
                    $('#ChatBody').scrollTop($('#ChatBody')[0].scrollHeight);
                    updateDashboardData();
                },
                error: function() {
                    // Remove the typing indicator
                    $(".typing-indicator-wrapper").remove();

                    alert("An error occurred. Please try again.");

                    // Re-enable the send button and input field
                    $("#send-message").prop("disabled", false);
                    $("#user-message").prop("disabled", false);
                }
            })
        });
        
    });

    $(document).ready(function(){
        $("#user-message").keypress(function(event){
            if(event.keyCode == 13){
                event.preventDefault();
                $("#send-message").click();
            }
        });
    });
</script>

<footer class="footer">
    <div class="container">
        <div class="row align-items-center flex-row-reverse">
            <div class="col-md-12 col-sm-12 text-center">
                Built by  <a href="https://github.com/mialmodovar"> Miguel Almodovar </a> 
            </div>
        </div>
    </div>
</footer>
    </div>

    <!-- BACK-TO-TOP -->
    <a href=" {% static '#top' %} " id="back-to-top"><i class="fa fa-angle-up"></i></a>

    <!-- JQUERY JS -->
    <script src=" {% static '/assets/js/jquery.min.js' %} "></script>

    <!-- BOOTSTRAP JS -->
    <script src=" {% static '/assets/plugins/bootstrap/js/popper.min.js' %} "></script>
    <script src=" {% static '/assets/plugins/bootstrap/js/bootstrap.min.js' %} "></script>

	<!-- TypeHead js -->
	<script src=" {% static '/assets/plugins/bootstrap5-typehead/autocomplete.js' %} "></script>
    <script src=" {% static '/assets/js/typehead.js' %} "></script>

    <!-- Perfect SCROLLBAR JS-->
    <script src=" {% static '/assets/plugins/p-scroll/perfect-scrollbar.js' %} "></script>
    <script src=" {% static '/assets/plugins/p-scroll/pscroll.js' %} "></script>
    <script src=" {% static '/assets/plugins/p-scroll/pscroll-1.js' %} "></script>

    <!-- SIDE-MENU JS -->
    <script src=" {% static '/assets/plugins/sidemenu/sidemenu.js' %} "></script>

    <!-- SIDEBAR JS -->
    <script src=" {% static '/assets/plugins/sidebar/sidebar.js' %} "></script>

    <!-- Color Theme js -->
    <script src=" {% static '/assets/js/themeColors.js' %} "></script>

    <!-- Sticky js -->
    <script src=" {% static '/assets/js/sticky.js' %} "></script>

    <!-- CUSTOM JS -->
    <script src=" {% static '/assets/js/custom.js' %} "></script>

    <!-- Custom-switcher -->
    <script src=" {% static '/assets/js/custom-swicher.js' %} "></script>

    <!-- Switcher js -->
    <script src=" {% static '/assets/switcher/js/switcher.js' %} "></script>

</body>

</html>